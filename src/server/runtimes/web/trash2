import puppeteer from 'puppeteer';
import * as fs from 'fs';
import * as path from 'path';

console.log("hoist");

/**
 * Web test hoist - runs a JavaScript bundle in a headless Chromium browser
 */
async function main() {
  try {

    // hardcode for now
    const htmlPath = 'testeranto/bundles/allTests/web/example/Calculator.test.ts.html';  //path.resolve(args[0]);


    // Connect to Chrome browser running in web-builder container
    // Poll continuously until Chrome is ready
    let browser;
    let attempts = 0;
    const maxAttempts = 30;

    while (attempts < maxAttempts) {
      try {
        console.log(`Attempting to connect to Chrome (attempt ${attempts + 1}/${maxAttempts})...`);
        // Create a timeout promise
        const timeoutPromise = new Promise((_, reject) => {
          setTimeout(() => reject(new Error('Fetch timeout')), 5000);
        });

        const fetchPromise = fetch('http://web-builder:9222/json/version');
        const response = await Promise.race([fetchPromise, timeoutPromise]) as Response;
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        const data = await response.json();
        const wsEndpoint = data.webSocketDebuggerUrl;
        console.log(`Chrome ready: ${wsEndpoint}`);
        // The endpoint from Chrome is ws://localhost:9222/devtools/browser/...
        // But we need to connect to web-builder-allTests:9222
        // Replace localhost with web-builder-allTests
        const networkWsEndpoint = wsEndpoint.replace('ws://localhost:', 'ws://web-builder:');
        console.log(`Using network WebSocket endpoint: ${networkWsEndpoint}`);
        browser = await puppeteer.connect({
          browserWSEndpoint: networkWsEndpoint,
          defaultViewport: null,
        });
        console.log('Successfully connected to Chrome');
        break;
      } catch (error) {
        console.log(`Connection attempt ${attempts + 1} failed: ${error.message}`);
        attempts++;
        if (attempts >= maxAttempts) {
          throw new Error(`Failed to connect to Chrome after ${maxAttempts} attempts: ${error.message}`);
        }
        // Wait 2 seconds and try again
        await new Promise(resolve => setTimeout(resolve, 2000));
      }
    }

    if (!browser) {
      throw new Error('Failed to connect to Chrome browser');
    }

    const page = await browser.newPage();
    page.on('pageerror', (error) => {
      console.error(`Page error: ${error.message}`);
    });
    page.on('console', (msg) => {
      console.log(`Browser ${msg.type()}: ${msg.text()}`);
    });

    console.log(`Loading: ${htmlPath}`);
    await page.goto(`file://${htmlPath}`, { waitUntil: 'networkidle0' });
    await new Promise(resolve => setTimeout(resolve, 3000));

    await page.close();
    await browser.disconnect();
    console.log('Web test finished successfully');
    process.exit(0);

  } catch (error) {
    console.error('Error connecting to Chrome:', error);
    process.exit(1);
  }

}

main()
