import fs from "fs";
import path from "path";
import esbuild from "esbuild";
import { IBuiltConfig } from "../../../Types";
import nodeConfiger from "./esbuild";
import {
  computeFilesHash,
  sendSourceFilesUpdated,
  extractInputFilesFromMetafile,
  processMetafileAndSendUpdates
} from "../common";

const projectName = process.argv[2];

// run esbuild in watch mode using esbuildConfigs. Write to fs the bundle and metafile
async function startBundling(
  config: IBuiltConfig
) {
  console.log(`NODE BUILDER is now bundling:  ${projectName}`);
  const n = nodeConfiger(config, projectName);

  const buildResult = await esbuild.build(n);

  const metafilesDir =
    process.env.METAFILES_DIR || "/workspace/testeranto/metafiles/node";

  const metafilePath = path.join(metafilesDir, "allTests.json");

  if (buildResult.metafile) {
    const metafileWrapper = {
      errors: [],
      warnings: [],
      metafile: buildResult.metafile,
    };
    fs.writeFileSync(metafilePath, JSON.stringify(metafileWrapper, null, 2));

    // Process metafile and send updates using shared function
    await processMetafileAndSendUpdates(config, buildResult.metafile, 'node');

  } else {
    console.warn("No metafile generated by esbuild");
  }

}

async function main() {
  // // Print details about the projectName path
  // console.log(`NODE BUILDER: projectName is: ${projectName}`);

  // // Check if the path exists and its type
  // try {
  //   const stats = fs.statSync(projectName);
  //   console.log(`Path exists. Is directory: ${stats.isDirectory()}, Is file: ${stats.isFile()}`);

  //   // List contents if it's a directory
  //   if (stats.isDirectory()) {
  //     console.log(`Directory contents:`);
  //     const files = fs.readdirSync(projectName);
  //     files.forEach(file => {
  //       const filePath = path.join(projectName, file);
  //       const fileStats = fs.statSync(filePath);
  //       console.log(`  ${file} - ${fileStats.isDirectory() ? 'directory' : 'file'}`);
  //     });
  //   }
  // } catch (error) {
  //   console.log(`Error checking path: ${error.message}`);
  // }

  // // Try to import the config
  // try {
  //   const config = (await import(projectName)).default;
  //   console.log(`Successfully imported config from ${projectName}`);
  //   await startBundling(config);
  // } catch (error) {
  //   console.error("NODE BUILDER: Error importing config:", error);
  //   process.exit(1);
  // }
}

main();
