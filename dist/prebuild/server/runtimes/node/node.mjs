import {
  esbuildConfigs_default,
  featuresPlugin_default,
  inputFilesPlugin_default,
  rebuildPlugin_default
} from "../../../chunk-ESDZGA4F.mjs";
import "../../../chunk-Y6FXYEAI.mjs";

// src/server/runtimes/node/node.ts
import fs from "fs";
import path from "path";
import esbuild from "esbuild";
import { WebSocket } from "ws";

// src/server/runtimes/node/esbuild.ts
var absoluteBundlesDir = (c) => {
  return "./testeranto/bundles/allTests/node/";
};
var esbuild_default = (config, testName2) => {
  const entrypoints = ["./example/Calculator.test.ts"];
  const { inputFilesPluginFactory, register } = inputFilesPlugin_default(
    "node",
    testName2
  );
  return {
    ...esbuildConfigs_default(config),
    // splitting: false, // Disable splitting since each entry point is separate
    outdir: absoluteBundlesDir(config),
    outbase: ".",
    // Preserve directory structure relative to outdir
    metafile: true,
    supported: {
      "dynamic-import": true
    },
    define: {
      "process.env.FLUENTFFMPEG_COV": "0",
      ENV: `"node"`
    },
    bundle: true,
    format: "esm",
    absWorkingDir: process.cwd(),
    platform: "node",
    // external: ["react", ...config.node.externals],
    packages: "external",
    entryPoints: entrypoints,
    plugins: [
      featuresPlugin_default,
      inputFilesPluginFactory,
      rebuildPlugin_default("node"),
      ...config.node.plugins.map((p) => p(register, entrypoints)) || []
    ]
  };
};

// src/server/runtimes/node/node.ts
var testName = process.argv[2];
async function computeFilesHash(files) {
  const crypto = await import("crypto");
  const hash = crypto.createHash("md5");
  for (const file of files) {
    try {
      const stats = fs.statSync(file);
      hash.update(file);
      hash.update(stats.mtimeMs.toString());
      hash.update(stats.size.toString());
    } catch (error) {
      hash.update(file);
      hash.update("missing");
    }
  }
  return hash.digest("hex");
}
async function sendSourceFilesUpdated(config, testName2, hash, files) {
  return new Promise((resolve, reject) => {
    const wsUrl = `ws://host.docker.internal:${config.httpPort}/ws`;
    console.log(`[Node Builder] Connecting to WebSocket at ${wsUrl}`);
    const ws = new WebSocket(wsUrl);
    ws.on("open", () => {
      console.log(`[Node Builder] WebSocket connected, sending sourceFilesUpdated for ${testName2}`);
      ws.send(JSON.stringify({
        type: "sourceFilesUpdated",
        data: {
          testName: testName2,
          hash,
          files
        }
      }));
      setTimeout(() => {
        ws.close();
        resolve();
      }, 1e3);
    });
    ws.on("error", (error) => {
      console.error(`[Node Builder] WebSocket error:`, error);
      reject(error);
    });
    ws.on("close", () => {
      console.log(`[Node Builder] WebSocket connection closed`);
    });
  });
}
function extractInputFilesFromMetafile(metafile) {
  const files = [];
  if (metafile && metafile.inputs) {
    for (const inputPath of Object.keys(metafile.inputs)) {
      files.push(path.resolve(process.cwd(), inputPath));
    }
  }
  return files;
}
async function startBundling(config) {
  console.log(`NODE BUILDER is now bundling:  ${testName}`);
  const n = esbuild_default(config, testName);
  const bv = await esbuild.build(n);
  const metafilesDir = process.env.METAFILES_DIR || "/workspace/testeranto/metafiles/node";
  const metafilePath = path.join(metafilesDir, "allTests.json");
  let inputFiles = [];
  let hash = "";
  if (bv.metafile) {
    const metafileWrapper = {
      errors: [],
      warnings: [],
      metafile: bv.metafile
    };
    fs.writeFileSync(metafilePath, JSON.stringify(metafileWrapper, null, 2));
    console.log(`Node metafile written to ${metafilePath}`);
    inputFiles = extractInputFilesFromMetafile(bv.metafile);
    console.log(`[Node Builder] Found ${inputFiles.length} input files`);
    hash = await computeFilesHash(inputFiles);
    console.log(`[Node Builder] Computed hash: ${hash}`);
    try {
      await sendSourceFilesUpdated(config, testName, hash, inputFiles);
      console.log(`[Node Builder] Successfully sent sourceFilesUpdated message`);
    } catch (error) {
      console.error(`[Node Builder] Failed to send sourceFilesUpdated:`, error);
    }
  } else {
    console.warn("No metafile generated by esbuild");
  }
}
async function main() {
  const config = (await import(`/workspace/${testName}`)).default;
  try {
    await startBundling(config);
  } catch (error) {
    console.error("NODE BUILDER: Error:", error);
    process.exit(1);
  }
}
main();
