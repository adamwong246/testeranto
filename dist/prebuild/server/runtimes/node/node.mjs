import {
  esbuildConfigs_default,
  featuresPlugin_default,
  inputFilesPlugin_default,
  processMetafile,
  rebuildPlugin_default
} from "../../../chunk-MU5PJQAO.mjs";

// src/server/runtimes/node/node.ts
import esbuild from "esbuild";

// src/server/runtimes/node/esbuild.ts
var absoluteBundlesDir = (c) => {
  return "./testeranto/bundles/allTests/node/";
};
var esbuild_default = (config, testName2) => {
  let entrypoints = [];
  if (config.node?.tests) {
    entrypoints = Object.keys(config.node.tests);
  } else {
    entrypoints = ["./example/Calculator.test.ts"];
    console.warn(`No node.tests found in config, using default entry point: ${entrypoints[0]}`);
  }
  const { inputFilesPluginFactory, register } = inputFilesPlugin_default(
    "node",
    testName2
  );
  return {
    ...esbuildConfigs_default(config),
    outdir: absoluteBundlesDir(config),
    outbase: ".",
    // Preserve directory structure relative to outdir
    metafile: true,
    supported: {
      "dynamic-import": true
    },
    define: {
      "process.env.FLUENTFFMPEG_COV": "0",
      ENV: `"node"`
    },
    bundle: true,
    format: "esm",
    absWorkingDir: process.cwd(),
    platform: "node",
    packages: "external",
    entryPoints: entrypoints,
    plugins: [
      featuresPlugin_default,
      inputFilesPluginFactory,
      rebuildPlugin_default("node"),
      ...config.node?.plugins?.map((p) => p(register, entrypoints)) || []
    ]
  };
};

// src/server/runtimes/node/node.ts
var configFilePath = process.argv[2];
var testName = process.argv[3] || "allTests";
async function startBundling(config) {
  console.log(`[NODE BUILDER] is now bundling:  ${testName}`);
  const n = esbuild_default(config, testName);
  const buildResult = await esbuild.build(n);
  if (buildResult.metafile) {
    await processMetafile(config, buildResult.metafile, "node");
  } else {
    console.warn("No metafile generated by esbuild");
  }
}
async function main() {
  try {
    const config = (await import(configFilePath)).default;
    await startBundling(config);
  } catch (error) {
    console.error("NODE BUILDER: Error importing config:", configFilePath, error);
    console.error(error);
    process.exit(1);
  }
}
main();
