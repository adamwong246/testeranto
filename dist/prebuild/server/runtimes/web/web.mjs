import {
  esbuildConfigs_default,
  featuresPlugin_default,
  inputFilesPlugin_default,
  rebuildPlugin_default
} from "../../../chunk-ESDZGA4F.mjs";
import {
  __require
} from "../../../chunk-Y6FXYEAI.mjs";

// src/server/runtimes/web/web.ts
import esbuild from "esbuild";
import fs from "fs";
import path from "path";
import puppeteer from "puppeteer-core";

// src/server/runtimes/web/esbuild.ts
var absoluteBundlesDir = (c) => {
  return "./testeranto/bundles/allTests/web/";
};
var esbuild_default = (config, testName2) => {
  const entrypoints = ["./example/Calculator.test.ts"];
  const { inputFilesPluginFactory, register } = inputFilesPlugin_default(
    "web",
    testName2
  );
  return {
    ...esbuildConfigs_default(config),
    outdir: absoluteBundlesDir(config),
    outbase: ".",
    metafile: true,
    supported: {
      "dynamic-import": true
    },
    define: {
      "process.env.FLUENTFFMPEG_COV": "0",
      ENV: `"web"`
    },
    absWorkingDir: process.cwd(),
    platform: "browser",
    packages: "external",
    entryPoints: entrypoints,
    bundle: true,
    format: "esm",
    plugins: [
      featuresPlugin_default,
      inputFilesPluginFactory,
      rebuildPlugin_default("web"),
      ...config.web?.plugins?.map((p) => p(register, entrypoints)) || []
    ]
  };
};

// src/server/runtimes/web/web.ts
var testName = process.argv[2];
var mode = process.argv[3] || "dev";
var browser;
async function startChromeBrowser() {
  console.log("Starting Chrome browser via Puppeteer...");
  try {
    browser = await puppeteer.launch({
      slowMo: 1,
      waitForInitialPage: false,
      executablePath: process.env.CHROMIUM_PATH || "/usr/bin/chromium-browser",
      defaultViewport: null,
      dumpio: true,
      // Enable to see browser logs in Docker
      args: [
        "--remote-debugging-port=9222",
        "--remote-debugging-address=0.0.0.0",
        // Allow connections from outside the container
        "--no-sandbox",
        "--disable-setuid-sandbox",
        "--disable-dev-shm-usage",
        "--disable-accelerated-2d-canvas",
        "--disable-gpu",
        "--window-size=1920,1080",
        "--headless=new"
      ],
      headless: true
    });
    console.log("Chrome browser started with remote debugging on port 9222");
    console.log(`WebSocket endpoint: ${browser.wsEndpoint()}`);
    return browser;
  } catch (error) {
    throw new Error(`Chrome is not available: ${error.message}`);
  }
}
async function extractFilesFromPage(page) {
  return await page.evaluate(() => {
    return window.__testeranto_files__ || {};
  });
}
async function saveExtractedFiles(files, basePath) {
  const fs2 = __require("fs");
  const path2 = __require("path");
  for (const [filename, content] of Object.entries(files)) {
    const fullPath = path2.join(basePath, filename);
    const dir = path2.dirname(fullPath);
    if (!fs2.existsSync(dir)) {
      fs2.mkdirSync(dir, { recursive: true });
    }
    fs2.writeFileSync(fullPath, content);
    console.log(`Saved file: ${fullPath}`);
  }
}
async function startBundling(config) {
  const webConfig = esbuild_default(config, testName);
  const buildResult = await esbuild.build(webConfig);
  if (buildResult.errors.length > 0) {
    console.error("WEB BUILDER build errors:", buildResult.errors);
  }
  if (buildResult.warnings.length > 0) {
    console.warn("WEB BUILDER build warnings:", buildResult.warnings);
  }
  console.log(`WEB BUILDER build completed for ${testName}`);
  const metafilesDir = process.env.METAFILES_DIR || "/workspace/testeranto/metafiles/web";
  if (!fs.existsSync(metafilesDir)) {
    fs.mkdirSync(metafilesDir, { recursive: true });
  }
  const generatedMetafilePath = path.join(metafilesDir, "allTests.json");
  if (buildResult.metafile) {
    const metafileWrapper = {
      errors: [],
      warnings: [],
      metafile: buildResult.metafile
    };
    fs.writeFileSync(
      generatedMetafilePath,
      JSON.stringify(metafileWrapper, null, 2)
    );
    console.log(`Web metafile written to ${generatedMetafilePath}`);
  } else {
    console.warn("No metafile generated by esbuild");
  }
  await startChromeBrowser();
  console.log("WEB BUILDER: Chrome is now hosted and ready for test execution");
  console.log("WEB BUILDER: Metafiles have been generated");
  await runTestsAndExtractFiles(config);
  if (mode === "dev") {
    console.log(
      "WEB BUILDER: Running in dev mode, keeping Chrome instance alive..."
    );
    console.log("WEB BUILDER: Setting up file watcher for rebuilds...");
    const ctx = await esbuild.context(webConfig);
    await ctx.watch();
    process.on("SIGINT", async () => {
      console.log("WEB BUILDER: Shutting down...");
      if (browser) await browser.close();
      process.exit(0);
    });
    await new Promise(() => {
    });
  }
}
async function runTestsAndExtractFiles(config) {
  try {
    const page = await browser.newPage();
    const testBundlePath = `file://${process.cwd()}/testeranto/bundles/allTests/web/example/Calculator.test.mjs`;
    console.log(`Navigating to test bundle: ${testBundlePath}`);
    await page.goto(testBundlePath);
    const maxWaitTime = 3e4;
    const startTime = Date.now();
    while (Date.now() - startTime < maxWaitTime) {
      const hasFiles = await page.evaluate(() => {
        return !!window.__testeranto_files__ && Object.keys(window.__testeranto_files__).length > 0;
      });
      if (hasFiles) {
        console.log("Tests have written files, proceeding to extract...");
        break;
      }
      await new Promise((resolve) => setTimeout(resolve, 1e3));
    }
    console.log("Extracting files...");
    const files = await extractFilesFromPage(page);
    const basePath = process.cwd();
    await saveExtractedFiles(files, basePath);
    console.log(`Extracted ${Object.keys(files).length} files`);
    await page.close();
  } catch (error) {
    console.error("Error running tests and extracting files:", error);
  }
}
async function main() {
  const configPathBase = `/workspace/${testName}`;
  const config = (await import(`/workspace/${testName}`)).default;
  try {
    await startBundling(config);
    if (mode === "dev") {
      console.log("WEB BUILDER: Running in dev mode, keeping process alive...");
      process.on("SIGINT", async () => {
        console.log("WEB BUILDER: Shutting down...");
        if (browser) await browser.close();
        process.exit(0);
      });
    }
  } catch (error) {
    console.error("WEB BUILDER: Error:", error);
    if (browser) await browser.close();
    process.exit(1);
  }
}
main();
