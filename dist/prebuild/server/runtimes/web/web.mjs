import {
  esbuildConfigs_default,
  featuresPlugin_default,
  inputFilesPlugin_default,
  processMetafile,
  rebuildPlugin_default
} from "../../../chunk-MU5PJQAO.mjs";

// src/server/runtimes/web/web.ts
import esbuild from "esbuild";

// src/server/runtimes/web/esbuild.ts
var absoluteBundlesDir = (c) => {
  return "./testeranto/bundles/allTests/web/";
};
var esbuild_default = (config, testName2) => {
  const entrypoints = ["./example/Calculator.test.ts"];
  const { inputFilesPluginFactory, register } = inputFilesPlugin_default(
    "web",
    testName2
  );
  return {
    ...esbuildConfigs_default(config),
    outdir: absoluteBundlesDir(config),
    outbase: ".",
    metafile: true,
    supported: {
      "dynamic-import": true
    },
    define: {
      "process.env.FLUENTFFMPEG_COV": "0",
      ENV: `"web"`
    },
    absWorkingDir: process.cwd(),
    platform: "browser",
    packages: "external",
    entryPoints: entrypoints,
    bundle: true,
    format: "esm",
    plugins: [
      featuresPlugin_default,
      inputFilesPluginFactory,
      rebuildPlugin_default("web"),
      ...config.web?.plugins?.map((p) => p(register, entrypoints)) || []
    ]
  };
};

// src/server/runtimes/web/web.ts
import * as fs from "fs";
import * as path from "path";
var configFilePath = "/workspace/testeranto/runtimes/web/web.js";
var testName = process.argv[3] || "allTests";
async function startBundling(config) {
  console.log(`[WEB BUILDER] is now bundling:  ${testName}`);
  if (!config) {
    throw new Error("Config is undefined");
  }
  if (!config.buildDir) {
    console.warn("config.buildDir is undefined, using default");
    config.buildDir = "/workspace";
  }
  console.log(`Using build directory: ${config.buildDir}`);
  console.log("[WEB BUILDER] Using external browser service (browserless/chrome)");
  const webConfig = esbuild_default(config, "allTests");
  const buildResult = await esbuild.build(webConfig);
  if (buildResult.metafile) {
    await processMetafile(config, buildResult.metafile, "web");
    const outputFiles = Object.keys(buildResult.metafile.outputs);
    for (const outputFile of outputFiles) {
      if (true) {
        const htmlPath = `testeranto/bundles/allTests/web/example/Calculator.test.ts.html`;
        await fs.promises.mkdir(path.dirname(htmlPath), { recursive: true });
        const htmlContent = `<!DOCTYPE html>
    <html>
    <head>
        <meta charset="UTF-8">
        <title>Test Runner</title>
    </head>
    <body>
        <div id="root"></div>
        <script src="testeranto/bundles/allTests/web/example/Calculator.test.mjs"></script>
    </body>
    </html>`;
        await fs.promises.writeFile(htmlPath, htmlContent);
        console.log(`Created HTML file: ${htmlPath}`);
      }
    }
  } else {
    console.warn("No metafile generated by esbuild");
  }
  console.log("WEB BUILDER: Metafiles have been generated");
  if (true) {
    console.log(
      "WEB BUILDER: Running in dev mode, keeping builder alive..."
    );
    const ctx = await esbuild.context(webConfig);
    let { hosts, port } = await ctx.serve();
    console.log(
      `[WEB BUILDER]: esbuild server ${hosts}, ${port}`
    );
    process.on("SIGINT", async () => {
      console.log("WEB BUILDER: Shutting down...");
      process.exit(0);
    });
    await new Promise(() => {
    });
  }
}
async function main() {
  try {
    console.log(`[WEB BUILDER] Importing config from: ${configFilePath}`);
    const imported = await import(configFilePath);
    const config = imported.default;
    if (!config) {
      throw new Error(`Config not found in ${configFilePath}. Ensure the file exports a default object.`);
    }
    console.log("[WEB BUILDER] Config imported successfully:", Object.keys(config));
    await startBundling(config);
  } catch (error) {
    console.error("[WEB BUILDER]: Error importing config:", configFilePath, error);
    console.error(error);
    process.exit(1);
  }
}
main();
