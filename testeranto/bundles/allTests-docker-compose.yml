version: '3.8'
services:
  chromium:
    image: browserless/chrome:latest
    container_name: chromium
    restart: unless-stopped
    ports:
      - '4567:4567'
      - '9222:9222'
    shm_size: 2g
    environment:
      CONNECTION_TIMEOUT: '60000'
      MAX_CONCURRENT_SESSIONS: '10'
      ENABLE_CORS: 'true'
      REMOTE_DEBUGGING_PORT: '9222'
      REMOTE_DEBUGGING_ADDRESS: 0.0.0.0
      PORT: '4567'
    healthcheck:
      test:
        - CMD
        - curl
        - '-f'
        - http://localhost:4567/health
      interval: 10s
      timeout: 10s
      retries: 30
      start_period: 120s
    networks:
      - default
  aider-pool:
    image: paulgauthier/aider-full:latest
    restart: unless-stopped
    environment:
      PYTHONUNBUFFERED: '1'
      AIDER_POOL_HOST: 0.0.0.0
      AIDER_POOL_PORT: '8765'
      DEEPSEEK_API_KEY: sk-44ac90c2cca746e2b152dd3f97cbf36c
      GIT_AUTHOR_NAME: Testeranto Bot
      GIT_AUTHOR_EMAIL: bot@testeranto.local
      GIT_COMMITTER_NAME: Testeranto Bot
      GIT_COMMITTER_EMAIL: bot@testeranto.local
    networks:
      - default
    volumes:
      - /Users/adam/Code/testeranto:/workspace
      - node_modules:/workspace/node_modules
      - /var/run/docker.sock:/var/run/docker.sock
      - /Users/adam/Code/testeranto/.aider.conf.yml:/workspace/.aider.conf.yml:ro
    working_dir: /workspace
    ports:
      - '8765:8765'
      - 9000-9100:9000-9100
  node-build:
    build:
      context: /Users/adam/Code/testeranto
      dockerfile: testeranto/bundles/allTests/node/node.Dockerfile
      tags:
        - bundles-node-build:latest
      args:
        NODE_MJS_HASH: cab84cac12fc3913ce45e7e53425b8bb
    volumes:
      - /Users/adam/Code/testeranto:/workspace
      - node_modules:/workspace/node_modules
    image: bundles-node-build:latest
    restart: unless-stopped
    environment:
      BUNDLES_DIR: /workspace/testeranto/bundles/allTests/node
      METAFILES_DIR: /workspace/testeranto/metafiles/node
      ESBUILD_SERVE_PORT: '0'
      IN_DOCKER: 'true'
      COMPLETION_SIGNAL_PATH: /workspace/testeranto/metafiles/node/build_complete
    extra_hosts:
      - host.docker.internal:host-gateway
    command:
      - sh
      - '-c'
      - |-
        echo 'Starting node build in watch mode...'; 
                        echo 'Installing dependencies in /workspace/node_modules...'; 
                        cd /workspace &&                 # Remove any .npmrc files
                        rm -f .npmrc .npmrc.* || true &&                 # Clear npm cache and authentication
                        npm cache clean --force &&                 # Clear any npm authentication
                        npm config delete _auth 2>/dev/null || true &&                 npm config delete _authToken 2>/dev/null || true &&                 npm config delete //registry.npmjs.org/:_authToken 2>/dev/null || true &&                 npm config delete //registry.npmjs.org/:_auth 2>/dev/null || true &&                 npm config delete always-auth 2>/dev/null || true &&                 npm config delete registry 2>/dev/null || true &&                 npm config set registry https://registry.npmjs.org/ &&                 npm config set always-auth false &&                 npm install --legacy-peer-deps --no-audit --no-fund --ignore-scripts --no-optional || echo "npm install may have warnings";
                        echo 'Ensuring esbuild and esbuild-sass-plugin are installed for Linux platform...';
                        npm list esbuild 2>/dev/null || npm install --no-save esbuild@0.20.1 --no-audit --no-fund --ignore-scripts --no-optional || echo "esbuild installation may have issues";
                        npm list esbuild-sass-plugin 2>/dev/null || npm install --no-save esbuild-sass-plugin --no-audit --no-fund --ignore-scripts --no-optional || echo "esbuild-sass-plugin installation may have issues";
                        echo 'Creating output directory...'; 
                        mkdir -p /workspace/testeranto/bundles/allTests/node;
                        mkdir -p /workspace/testeranto/metafiles/node;
                        echo 'BUNDLES_DIR env:' "$BUNDLES_DIR"; 
                        
                        echo "Starting build process for node..."
                        npx tsx dist/prebuild/server/builders/node.mjs allTests.ts dev || echo "Build process exited with code $?, but keeping container alive for health checks";
                        
                        echo "Build complete. Creating completion signal..."
                        touch /workspace/testeranto/metafiles/node/build_complete
                        
                        echo "Build service ready. Keeping container alive..."
                        while true; do
                          sleep 3600
                        done
    healthcheck:
      test:
        - CMD-SHELL
        - '[ -f /workspace/testeranto/metafiles/node/allTests.json ] && echo "healthy" || exit 1'
      interval: 10s
      timeout: 30s
      retries: 10
      start_period: 60s
  node-analysis:
    restart: 'no'
    environment:
      RUNTIME: node
      WS_HOST: host.docker.internal
      WS_PORT: '3456'
      IN_DOCKER: 'true'
      COMPLETION_SIGNAL_PATH: /workspace/testeranto/metafiles/node/analysis_complete
    networks:
      - default
    image: node:20-alpine
    volumes:
      - /Users/adam/Code/testeranto:/workspace
      - node_modules:/workspace/node_modules
    working_dir: /workspace
    depends_on:
      node-build:
        condition: service_healthy
    command:
      - sh
      - '-c'
      - |2-

            echo "=== Starting static analysis for node ==="
            
            # Wait for build to complete
            echo "Waiting for build service to complete..."
            while [ ! -f /workspace/testeranto/metafiles/node/build_complete ]; do
              sleep 1
            done
            
            echo "Build complete. Running static analysis..."
            
            # Run static analysis based on runtime
            case "node" in
              "node"|"web")
                echo "Running Node.js/Web static analysis..."
                # Check if there are any checks configured
                if [ -n "$(echo '{"eslint":[[["WORKDIR","/workspace"],["RUN","npm install --save-dev eslint @typescript-eslint/parser @typescript-eslint/eslint-plugin"]],"npx eslint src/ --ext .ts,.tsx --max-warnings=0"],"typescript":[[["WORKDIR","/workspace"],["RUN","npm install --save-dev typescript"]],"npx tsc --noEmit"],"audit-ci":[[["WORKDIR","/workspace"],["RUN","npm install --save-dev audit-ci"]],"npx audit-ci --critical"],"depcheck":[[["WORKDIR","/workspace"],["RUN","npm install --save-dev depcheck"]],"npx depcheck"]}' | grep -v '^[{}]*$')" ]; then
                  echo "User-defined checks found, running analysis..."
                  # Run analysis (simplified for now)
                  find /workspace/src -name "*.ts" -o -name "*.tsx" | head -5 | while read file; do
                    echo "Analyzing: $file"
                  done
                else
                  echo "No checks configured, skipping analysis."
                fi
                ;;
              "python")
                echo "Running Python static analysis..."
                # Python analysis would go here
                ;;
              "golang")
                echo "Running Go static analysis..."
                # Go analysis would go here
                ;;
            esac
            
            echo "Static analysis complete. Creating completion signal..."
            touch /workspace/testeranto/metafiles/node/analysis_complete
            
            echo "Analysis service complete. Keeping container alive..."
            sleep 3600
          
  node-process-pool:
    restart: unless-stopped
    environment:
      RUNTIME: node
      WS_HOST: host.docker.internal
      WS_PORT: '3456'
      IN_DOCKER: 'true'
      MAX_CONCURRENT_TESTS: '4'
      TEST_TIMEOUT_MS: '30000'
    networks:
      - default
    image: node:20-alpine
    volumes:
      - /Users/adam/Code/testeranto:/workspace
      - node_modules:/workspace/node_modules
    working_dir: /workspace
    depends_on:
      node-build:
        condition: service_healthy
      node-analysis:
        condition: service_completed_successfully
    command:
      - sh
      - '-c'
      - |2-

            echo "Starting node process pool (type: undefined)..."
            
            # Wait for build and analysis to complete
            echo "Waiting for build and analysis services..."
            while [ ! -f /workspace/testeranto/metafiles/node/build_complete ] || 
                  [ ! -f /workspace/testeranto/metafiles/node/analysis_complete ]; do
              sleep 1
            done
            
            echo "Build and analysis complete. Starting process pool..."
            
            # Create metafiles directory if it doesn't exist
            mkdir -p /workspace/testeranto/metafiles/node
            
            # Start the appropriate process pool manager
            case "undefined" in
              "lightweight")
                echo "Starting lightweight process pool for node..."
                # For interpreted languages, we'll run tests directly
                echo "Lightweight process pool ready for node"
                ;;
              "binary")
                echo "Starting binary process pool for node..."
                echo "Binary process pool ready for node"
                ;;
              "shared-jvm")
                echo "Starting shared JVM process pool..."
                echo "Shared JVM process pool ready"
                ;;
              "shared-chrome")
                echo "Starting shared Chrome process pool..."
                echo "Shared Chrome process pool ready"
                ;;
            esac
            
            echo "Process pool running. Waiting for test execution requests..."
            
            # Keep container alive
            while true; do
              sleep 3600
            done
          
  web-build:
    build:
      context: /Users/adam/Code/testeranto
      dockerfile: testeranto/bundles/allTests/web/web.Dockerfile
      tags:
        - bundles-web-build:latest
      args: {}
    volumes:
      - /Users/adam/Code/testeranto:/workspace
      - node_modules:/workspace/node_modules
    image: bundles-web-build:latest
    restart: unless-stopped
    environment:
      BUNDLES_DIR: /workspace/testeranto/bundles/allTests/web
      METAFILES_DIR: /workspace/testeranto/metafiles/web
      ESBUILD_SERVE_PORT: '0'
      IN_DOCKER: 'true'
      COMPLETION_SIGNAL_PATH: /workspace/testeranto/metafiles/web/build_complete
    extra_hosts:
      - host.docker.internal:host-gateway
    command:
      - sh
      - '-c'
      - |-
        echo 'Starting web build in watch mode...'; 
                        echo 'Installing dependencies in /workspace/node_modules...'; 
                        cd /workspace &&                 # Remove any .npmrc files
                        rm -f .npmrc .npmrc.* || true &&                 # Clear npm cache and authentication
                        npm cache clean --force &&                 # Clear any npm authentication
                        npm config delete _auth 2>/dev/null || true &&                 npm config delete _authToken 2>/dev/null || true &&                 npm config delete //registry.npmjs.org/:_authToken 2>/dev/null || true &&                 npm config delete //registry.npmjs.org/:_auth 2>/dev/null || true &&                 npm config delete always-auth 2>/dev/null || true &&                 npm config delete registry 2>/dev/null || true &&                 npm config set registry https://registry.npmjs.org/ &&                 npm config set always-auth false &&                 npm install --legacy-peer-deps --no-audit --no-fund --ignore-scripts --no-optional || echo "npm install may have warnings";
                        echo 'Ensuring esbuild and esbuild-sass-plugin are installed for Linux platform...';
                        npm list esbuild 2>/dev/null || npm install --no-save esbuild@0.20.1 --no-audit --no-fund --ignore-scripts --no-optional || echo "esbuild installation may have issues";
                        npm list esbuild-sass-plugin 2>/dev/null || npm install --no-save esbuild-sass-plugin --no-audit --no-fund --ignore-scripts --no-optional || echo "esbuild-sass-plugin installation may have issues";
                        echo 'Creating output directory...'; 
                        mkdir -p /workspace/testeranto/bundles/allTests/web;
                        mkdir -p /workspace/testeranto/metafiles/web;
                        echo 'BUNDLES_DIR env:' "$BUNDLES_DIR"; 
                        
                        echo "Starting build process for web..."
                        npx tsx dist/prebuild/server/builders/web.mjs allTests.ts dev || echo "Build process exited with code $?, but keeping container alive for health checks";
                        
                        echo "Build complete. Creating completion signal..."
                        touch /workspace/testeranto/metafiles/web/build_complete
                        
                        echo "Build service ready. Keeping container alive..."
                        while true; do
                          sleep 3600
                        done
    healthcheck:
      test:
        - CMD-SHELL
        - '[ -f /workspace/testeranto/metafiles/web/allTests.json ] && echo "healthy" || exit 1'
      interval: 10s
      timeout: 30s
      retries: 10
      start_period: 60s
  web-analysis:
    restart: 'no'
    environment:
      RUNTIME: web
      WS_HOST: host.docker.internal
      WS_PORT: '3456'
      IN_DOCKER: 'true'
      COMPLETION_SIGNAL_PATH: /workspace/testeranto/metafiles/web/analysis_complete
    networks:
      - default
    image: node:20-alpine
    volumes:
      - /Users/adam/Code/testeranto:/workspace
      - node_modules:/workspace/node_modules
    working_dir: /workspace
    depends_on:
      web-build:
        condition: service_healthy
      chromium:
        condition: service_healthy
    command:
      - sh
      - '-c'
      - |2-

            echo "=== Starting static analysis for web ==="
            
            # Wait for build to complete
            echo "Waiting for build service to complete..."
            while [ ! -f /workspace/testeranto/metafiles/web/build_complete ]; do
              sleep 1
            done
            
            echo "Build complete. Running static analysis..."
            
            # Run static analysis based on runtime
            case "web" in
              "node"|"web")
                echo "Running Node.js/Web static analysis..."
                # Check if there are any checks configured
                if [ -n "$(echo '{"eslint":[[["WORKDIR","/workspace"],["RUN","npm install --save-dev eslint @typescript-eslint/parser @typescript-eslint/eslint-plugin"]],"npx eslint src/ --ext .ts,.tsx --max-warnings=0"],"typescript":[[["WORKDIR","/workspace"],["RUN","npm install --save-dev typescript"]],"npx tsc --noEmit"],"audit-ci":[[["WORKDIR","/workspace"],["RUN","npm install --save-dev audit-ci"]],"npx audit-ci --critical"],"depcheck":[[["WORKDIR","/workspace"],["RUN","npm install --save-dev depcheck"]],"npx depcheck"]}' | grep -v '^[{}]*$')" ]; then
                  echo "User-defined checks found, running analysis..."
                  # Run analysis (simplified for now)
                  find /workspace/src -name "*.ts" -o -name "*.tsx" | head -5 | while read file; do
                    echo "Analyzing: $file"
                  done
                else
                  echo "No checks configured, skipping analysis."
                fi
                ;;
              "python")
                echo "Running Python static analysis..."
                # Python analysis would go here
                ;;
              "golang")
                echo "Running Go static analysis..."
                # Go analysis would go here
                ;;
            esac
            
            echo "Static analysis complete. Creating completion signal..."
            touch /workspace/testeranto/metafiles/web/analysis_complete
            
            echo "Analysis service complete. Keeping container alive..."
            sleep 3600
          
  web-process-pool:
    restart: unless-stopped
    environment:
      RUNTIME: web
      WS_HOST: host.docker.internal
      WS_PORT: '3456'
      IN_DOCKER: 'true'
      MAX_CONCURRENT_TESTS: '4'
      TEST_TIMEOUT_MS: '30000'
      CHROME_MAX_CONTEXTS: '6'
      CHROME_MEMORY_LIMIT_MB: '512'
    networks:
      - default
    image: node:20-alpine
    volumes:
      - /Users/adam/Code/testeranto:/workspace
      - node_modules:/workspace/node_modules
    working_dir: /workspace
    depends_on:
      web-build:
        condition: service_healthy
      web-analysis:
        condition: service_completed_successfully
      chromium:
        condition: service_healthy
    command:
      - sh
      - '-c'
      - |2-

            echo "Starting web process pool (type: undefined)..."
            
            # Wait for build and analysis to complete
            echo "Waiting for build and analysis services..."
            while [ ! -f /workspace/testeranto/metafiles/web/build_complete ] || 
                  [ ! -f /workspace/testeranto/metafiles/web/analysis_complete ]; do
              sleep 1
            done
            
            echo "Build and analysis complete. Starting process pool..."
            
            # Create metafiles directory if it doesn't exist
            mkdir -p /workspace/testeranto/metafiles/web
            
            # Start the appropriate process pool manager
            case "undefined" in
              "lightweight")
                echo "Starting lightweight process pool for web..."
                # For interpreted languages, we'll run tests directly
                echo "Lightweight process pool ready for web"
                ;;
              "binary")
                echo "Starting binary process pool for web..."
                echo "Binary process pool ready for web"
                ;;
              "shared-jvm")
                echo "Starting shared JVM process pool..."
                echo "Shared JVM process pool ready"
                ;;
              "shared-chrome")
                echo "Starting shared Chrome process pool..."
                echo "Shared Chrome process pool ready"
                ;;
            esac
            
            echo "Process pool running. Waiting for test execution requests..."
            
            # Keep container alive
            while true; do
              sleep 3600
            done
          
  golang-build:
    build:
      context: /Users/adam/Code/testeranto
      dockerfile: testeranto/bundles/allTests/golang/golang.Dockerfile
      tags:
        - bundles-golang-build:latest
      args: {}
    volumes:
      - /Users/adam/Code/testeranto:/workspace
      - node_modules:/workspace/node_modules
    image: bundles-golang-build:latest
    restart: unless-stopped
    environment:
      BUNDLES_DIR: /workspace/testeranto/bundles/allTests/golang
      METAFILES_DIR: /workspace/testeranto/metafiles/golang
      ESBUILD_SERVE_PORT: '0'
      IN_DOCKER: 'true'
      COMPLETION_SIGNAL_PATH: /workspace/testeranto/metafiles/golang/build_complete
    extra_hosts:
      - host.docker.internal:host-gateway
    command:
      - sh
      - '-c'
      - |-
        echo 'Starting golang build in watch mode...'; 
                        echo 'Installing dependencies in /workspace/node_modules...'; 
                        cd /workspace &&                 # Remove any .npmrc files
                        rm -f .npmrc .npmrc.* || true &&                 # Clear npm cache and authentication
                        npm cache clean --force &&                 # Clear any npm authentication
                        npm config delete _auth 2>/dev/null || true &&                 npm config delete _authToken 2>/dev/null || true &&                 npm config delete //registry.npmjs.org/:_authToken 2>/dev/null || true &&                 npm config delete //registry.npmjs.org/:_auth 2>/dev/null || true &&                 npm config delete always-auth 2>/dev/null || true &&                 npm config delete registry 2>/dev/null || true &&                 npm config set registry https://registry.npmjs.org/ &&                 npm config set always-auth false &&                 npm install --legacy-peer-deps --no-audit --no-fund --ignore-scripts --no-optional || echo "npm install may have warnings";
                        echo 'Ensuring esbuild and esbuild-sass-plugin are installed for Linux platform...';
                        npm list esbuild 2>/dev/null || npm install --no-save esbuild@0.20.1 --no-audit --no-fund --ignore-scripts --no-optional || echo "esbuild installation may have issues";
                        npm list esbuild-sass-plugin 2>/dev/null || npm install --no-save esbuild-sass-plugin --no-audit --no-fund --ignore-scripts --no-optional || echo "esbuild-sass-plugin installation may have issues";
                        echo 'Creating output directory...'; 
                        mkdir -p /workspace/testeranto/bundles/allTests/golang;
                        mkdir -p /workspace/testeranto/metafiles/golang;
                        echo 'BUNDLES_DIR env:' "$BUNDLES_DIR"; 
                        
                        echo "Starting build process for golang..."
                        npx tsx dist/prebuild/server/builders/golang.mjs allTests.ts dev || echo "Build process exited with code $?, but keeping container alive for health checks";
                        
                        echo "Build complete. Creating completion signal..."
                        touch /workspace/testeranto/metafiles/golang/build_complete
                        
                        echo "Build service ready. Keeping container alive..."
                        while true; do
                          sleep 3600
                        done
    healthcheck:
      test:
        - CMD-SHELL
        - '[ -f /workspace/testeranto/metafiles/golang/allTests.json ] && echo "healthy" || exit 1'
      interval: 10s
      timeout: 30s
      retries: 10
      start_period: 60s
  golang-analysis:
    restart: 'no'
    environment:
      RUNTIME: golang
      WS_HOST: host.docker.internal
      WS_PORT: '3456'
      IN_DOCKER: 'true'
      COMPLETION_SIGNAL_PATH: /workspace/testeranto/metafiles/golang/analysis_complete
    networks:
      - default
    image: alpine:latest
    volumes:
      - /Users/adam/Code/testeranto:/workspace
      - node_modules:/workspace/node_modules
    working_dir: /workspace
    depends_on:
      golang-build:
        condition: service_healthy
    command:
      - sh
      - '-c'
      - |2-

            echo "=== Starting static analysis for golang ==="
            
            # Wait for build to complete
            echo "Waiting for build service to complete..."
            while [ ! -f /workspace/testeranto/metafiles/golang/build_complete ]; do
              sleep 1
            done
            
            echo "Build complete. Running static analysis..."
            
            # Run static analysis based on runtime
            case "golang" in
              "node"|"web")
                echo "Running Node.js/Web static analysis..."
                # Check if there are any checks configured
                if [ -n "$(echo '{"eslint":[[["WORKDIR","/workspace"],["RUN","npm install --save-dev eslint @typescript-eslint/parser @typescript-eslint/eslint-plugin"]],"npx eslint src/ --ext .ts,.tsx --max-warnings=0"],"typescript":[[["WORKDIR","/workspace"],["RUN","npm install --save-dev typescript"]],"npx tsc --noEmit"],"audit-ci":[[["WORKDIR","/workspace"],["RUN","npm install --save-dev audit-ci"]],"npx audit-ci --critical"],"depcheck":[[["WORKDIR","/workspace"],["RUN","npm install --save-dev depcheck"]],"npx depcheck"]}' | grep -v '^[{}]*$')" ]; then
                  echo "User-defined checks found, running analysis..."
                  # Run analysis (simplified for now)
                  find /workspace/src -name "*.ts" -o -name "*.tsx" | head -5 | while read file; do
                    echo "Analyzing: $file"
                  done
                else
                  echo "No checks configured, skipping analysis."
                fi
                ;;
              "python")
                echo "Running Python static analysis..."
                # Python analysis would go here
                ;;
              "golang")
                echo "Running Go static analysis..."
                # Go analysis would go here
                ;;
            esac
            
            echo "Static analysis complete. Creating completion signal..."
            touch /workspace/testeranto/metafiles/golang/analysis_complete
            
            echo "Analysis service complete. Keeping container alive..."
            sleep 3600
          
  golang-process-pool:
    restart: unless-stopped
    environment:
      RUNTIME: golang
      WS_HOST: host.docker.internal
      WS_PORT: '3456'
      IN_DOCKER: 'true'
      PROCESS_POOL_TYPE: lightweight
      MAX_CONCURRENT_TESTS: '4'
      TEST_TIMEOUT_MS: '30000'
    networks:
      - default
    image: alpine:latest
    volumes:
      - /Users/adam/Code/testeranto:/workspace
      - node_modules:/workspace/node_modules
    working_dir: /workspace
    depends_on:
      golang-build:
        condition: service_healthy
      golang-analysis:
        condition: service_completed_successfully
    command:
      - sh
      - '-c'
      - |2-

            echo "Starting golang process pool (type: lightweight)..."
            
            # Wait for build and analysis to complete
            echo "Waiting for build and analysis services..."
            while [ ! -f /workspace/testeranto/metafiles/golang/build_complete ] || 
                  [ ! -f /workspace/testeranto/metafiles/golang/analysis_complete ]; do
              sleep 1
            done
            
            echo "Build and analysis complete. Starting process pool..."
            
            # Create metafiles directory if it doesn't exist
            mkdir -p /workspace/testeranto/metafiles/golang
            
            # Start the appropriate process pool manager
            case "lightweight" in
              "lightweight")
                echo "Starting lightweight process pool for golang..."
                # For interpreted languages, we'll run tests directly
                echo "Lightweight process pool ready for golang"
                ;;
              "binary")
                echo "Starting binary process pool for golang..."
                echo "Binary process pool ready for golang"
                ;;
              "shared-jvm")
                echo "Starting shared JVM process pool..."
                echo "Shared JVM process pool ready"
                ;;
              "shared-chrome")
                echo "Starting shared Chrome process pool..."
                echo "Shared Chrome process pool ready"
                ;;
            esac
            
            echo "Process pool running. Waiting for test execution requests..."
            
            # Keep container alive
            while true; do
              sleep 3600
            done
          
  python-build:
    build:
      context: /Users/adam/Code/testeranto
      dockerfile: testeranto/bundles/allTests/python/python.Dockerfile
      tags:
        - bundles-python-build:latest
      args: {}
    volumes:
      - /Users/adam/Code/testeranto:/workspace
      - node_modules:/workspace/node_modules
    image: bundles-python-build:latest
    restart: unless-stopped
    environment:
      BUNDLES_DIR: /workspace/testeranto/bundles/allTests/python
      METAFILES_DIR: /workspace/testeranto/metafiles/python
      ESBUILD_SERVE_PORT: '0'
      IN_DOCKER: 'true'
      COMPLETION_SIGNAL_PATH: /workspace/testeranto/metafiles/python/build_complete
    extra_hosts:
      - host.docker.internal:host-gateway
    command:
      - sh
      - '-c'
      - |-
        echo 'Starting python build in watch mode...'; 
                        echo 'Installing dependencies in /workspace/node_modules...'; 
                        cd /workspace &&                 # Remove any .npmrc files
                        rm -f .npmrc .npmrc.* || true &&                 # Clear npm cache and authentication
                        npm cache clean --force &&                 # Clear any npm authentication
                        npm config delete _auth 2>/dev/null || true &&                 npm config delete _authToken 2>/dev/null || true &&                 npm config delete //registry.npmjs.org/:_authToken 2>/dev/null || true &&                 npm config delete //registry.npmjs.org/:_auth 2>/dev/null || true &&                 npm config delete always-auth 2>/dev/null || true &&                 npm config delete registry 2>/dev/null || true &&                 npm config set registry https://registry.npmjs.org/ &&                 npm config set always-auth false &&                 npm install --legacy-peer-deps --no-audit --no-fund --ignore-scripts --no-optional || echo "npm install may have warnings";
                        echo 'Ensuring esbuild and esbuild-sass-plugin are installed for Linux platform...';
                        npm list esbuild 2>/dev/null || npm install --no-save esbuild@0.20.1 --no-audit --no-fund --ignore-scripts --no-optional || echo "esbuild installation may have issues";
                        npm list esbuild-sass-plugin 2>/dev/null || npm install --no-save esbuild-sass-plugin --no-audit --no-fund --ignore-scripts --no-optional || echo "esbuild-sass-plugin installation may have issues";
                        echo 'Creating output directory...'; 
                        mkdir -p /workspace/testeranto/bundles/allTests/python;
                        mkdir -p /workspace/testeranto/metafiles/python;
                        echo 'BUNDLES_DIR env:' "$BUNDLES_DIR"; 
                        
                        echo "Starting build process for python..."
                        npx tsx dist/prebuild/server/builders/python.mjs allTests.ts dev || echo "Build process exited with code $?, but keeping container alive for health checks";
                        
                        echo "Build complete. Creating completion signal..."
                        touch /workspace/testeranto/metafiles/python/build_complete
                        
                        echo "Build service ready. Keeping container alive..."
                        while true; do
                          sleep 3600
                        done
    healthcheck:
      test:
        - CMD-SHELL
        - '[ -f /workspace/testeranto/metafiles/python/allTests.json ] && echo "healthy" || exit 1'
      interval: 10s
      timeout: 30s
      retries: 10
      start_period: 60s
  python-analysis:
    restart: 'no'
    environment:
      RUNTIME: python
      WS_HOST: host.docker.internal
      WS_PORT: '3456'
      IN_DOCKER: 'true'
      COMPLETION_SIGNAL_PATH: /workspace/testeranto/metafiles/python/analysis_complete
    networks:
      - default
    image: python:3.11-alpine
    volumes:
      - /Users/adam/Code/testeranto:/workspace
      - node_modules:/workspace/node_modules
    working_dir: /workspace
    depends_on:
      python-build:
        condition: service_healthy
    command:
      - sh
      - '-c'
      - |2-

            echo "=== Starting static analysis for python ==="
            
            # Wait for build to complete
            echo "Waiting for build service to complete..."
            while [ ! -f /workspace/testeranto/metafiles/python/build_complete ]; do
              sleep 1
            done
            
            echo "Build complete. Running static analysis..."
            
            # Run static analysis based on runtime
            case "python" in
              "node"|"web")
                echo "Running Node.js/Web static analysis..."
                # Check if there are any checks configured
                if [ -n "$(echo '{"eslint":[[["WORKDIR","/workspace"],["RUN","npm install --save-dev eslint @typescript-eslint/parser @typescript-eslint/eslint-plugin"]],"npx eslint src/ --ext .ts,.tsx --max-warnings=0"],"typescript":[[["WORKDIR","/workspace"],["RUN","npm install --save-dev typescript"]],"npx tsc --noEmit"],"audit-ci":[[["WORKDIR","/workspace"],["RUN","npm install --save-dev audit-ci"]],"npx audit-ci --critical"],"depcheck":[[["WORKDIR","/workspace"],["RUN","npm install --save-dev depcheck"]],"npx depcheck"]}' | grep -v '^[{}]*$')" ]; then
                  echo "User-defined checks found, running analysis..."
                  # Run analysis (simplified for now)
                  find /workspace/src -name "*.ts" -o -name "*.tsx" | head -5 | while read file; do
                    echo "Analyzing: $file"
                  done
                else
                  echo "No checks configured, skipping analysis."
                fi
                ;;
              "python")
                echo "Running Python static analysis..."
                # Python analysis would go here
                ;;
              "golang")
                echo "Running Go static analysis..."
                # Go analysis would go here
                ;;
            esac
            
            echo "Static analysis complete. Creating completion signal..."
            touch /workspace/testeranto/metafiles/python/analysis_complete
            
            echo "Analysis service complete. Keeping container alive..."
            sleep 3600
          
  python-process-pool:
    restart: unless-stopped
    environment:
      RUNTIME: python
      WS_HOST: host.docker.internal
      WS_PORT: '3456'
      IN_DOCKER: 'true'
      MAX_CONCURRENT_TESTS: '4'
      TEST_TIMEOUT_MS: '30000'
    networks:
      - default
    image: python:3.11-alpine
    volumes:
      - /Users/adam/Code/testeranto:/workspace
      - node_modules:/workspace/node_modules
    working_dir: /workspace
    depends_on:
      python-build:
        condition: service_healthy
      python-analysis:
        condition: service_completed_successfully
    command:
      - sh
      - '-c'
      - |2-

            echo "Starting python process pool (type: undefined)..."
            
            # Wait for build and analysis to complete
            echo "Waiting for build and analysis services..."
            while [ ! -f /workspace/testeranto/metafiles/python/build_complete ] || 
                  [ ! -f /workspace/testeranto/metafiles/python/analysis_complete ]; do
              sleep 1
            done
            
            echo "Build and analysis complete. Starting process pool..."
            
            # Create metafiles directory if it doesn't exist
            mkdir -p /workspace/testeranto/metafiles/python
            
            # Start the appropriate process pool manager
            case "undefined" in
              "lightweight")
                echo "Starting lightweight process pool for python..."
                # For interpreted languages, we'll run tests directly
                echo "Lightweight process pool ready for python"
                ;;
              "binary")
                echo "Starting binary process pool for python..."
                echo "Binary process pool ready for python"
                ;;
              "shared-jvm")
                echo "Starting shared JVM process pool..."
                echo "Shared JVM process pool ready"
                ;;
              "shared-chrome")
                echo "Starting shared Chrome process pool..."
                echo "Shared Chrome process pool ready"
                ;;
            esac
            
            echo "Process pool running. Waiting for test execution requests..."
            
            # Keep container alive
            while true; do
              sleep 3600
            done
          
volumes:
  node_modules:
    driver: local
networks:
  default:
    name: allTests_network
