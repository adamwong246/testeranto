version: '3.8'
services:
  node-builder:
    build:
      context: /Users/adam/Code/testeranto
      dockerfile: testeranto/bundles/allTests/node/node.Dockerfile
      tags:
        - bundles-node-build:latest
      args:
        NODE_MJS_HASH: cab84cac12fc3913ce45e7e563425b8bb
    volumes:
      - /Users/adam/Code/testeranto/testeranto:/workspace/testeranto
      - /Users/adam/Code/testeranto/src:/workspace/src
      - /Users/adam/Code/testeranto/example:/workspace/example
      - /Users/adam/Code/testeranto/dist:/workspace/dist
      - /Users/adam/Code/testeranto/allTests.ts:/workspace/allTests.ts
      - /Users/adam/Code/testeranto/allTestsUtils.ts:/workspace/allTestsUtils.ts
    image: bundles-node-build:latest
    restart: unless-stopped
    environment:
      BUNDLES_DIR: /workspace/testeranto/bundles/allTests/node
      METAFILES_DIR: /workspace/testeranto/metafiles/node
      IN_DOCKER: 'true'
    extra_hosts:
      - host.docker.internal:host-gateway
    command:
      - sh
      - '-c'
      - TEST_NAME=allTests WS_PORT=3456 yarn tsx dist/prebuild/server/runtimes/node/node.mjs allTests.ts dev || echo "Build process exited with code $?, but keeping container alive for health checks";
    healthcheck:
      test:
        - CMD-SHELL
        - '[ -f /workspace/testeranto/metafiles/node/allTests.json ] && echo "healthy" || exit 1'
      interval: 10s
      timeout: 30s
      retries: 10
      start_period: 60s
  web-builder:
    build:
      context: /Users/adam/Code/testeranto
      dockerfile: testeranto/bundles/allTests/web/web.Dockerfile
      tags:
        - bundles-web-build:latest
    volumes:
      - /Users/adam/Code/testeranto/testeranto:/workspace/testeranto
      - /Users/adam/Code/testeranto/src:/workspace/src
      - /Users/adam/Code/testeranto/example:/workspace/example
      - /Users/adam/Code/testeranto/dist:/workspace/dist
      - /Users/adam/Code/testeranto/allTests.ts:/workspace/allTests.ts
      - /Users/adam/Code/testeranto/allTestsUtils.ts:/workspace/allTestsUtils.ts
    image: bundles-web-build:latest
    restart: 'no'
    environment:
      BUNDLES_DIR: /workspace/testeranto/bundles/allTests/web
      METAFILES_DIR: /workspace/testeranto/metafiles/web
      ESBUILD_SERVE_PORT: '0'
      IN_DOCKER: 'true'
      CHROMIUM_PATH: /usr/bin/chromium-browser
    extra_hosts:
      - host.docker.internal:host-gateway
    ports:
      - '9222:9222'
    command:
      - sh
      - '-c'
      - TEST_NAME=allTests WS_PORT=3456 yarn tsx dist/prebuild/server/runtimes/web/web.mjs allTests.ts dev || echo "Build process exited with code $?, but keeping container alive for health checks";
  golang-builder:
    build:
      context: /Users/adam/Code/testeranto
      dockerfile: testeranto/bundles/allTests/golang/golang.Dockerfile
      tags:
        - bundles-golang-build:latest
    volumes:
      - /Users/adam/Code/testeranto:/workspace
    image: bundles-golang-build:latest
    restart: unless-stopped
    environment:
      BUNDLES_DIR: /workspace/testeranto/bundles/allTests/golang
      METAFILES_DIR: /workspace/testeranto/metafiles/golang
      ESBUILD_SERVE_PORT: '0'
      IN_DOCKER: 'true'
    extra_hosts:
      - host.docker.internal:host-gateway
    command:
      - sh
      - '-c'
      - |-
        echo 'Starting Go build service...'; 
               echo 'BUNDLES_DIR env:' "$BUNDLES_DIR"; 
               
               # Create necessary directories
               mkdir -p /workspace/testeranto/bundles/allTests/golang
               mkdir -p /workspace/testeranto/metafiles/golang
               
               # The Go metafile generator should already be built in the Dockerfile
               echo "Checking for Go metafile generator...";
               if [ -f /usr/local/bin/golang-main ]; then
                 echo "✅ Go metafile generator found at /usr/local/bin/golang-main";
               else
                 echo "❌ Go metafile generator not found at /usr/local/bin/golang-main";
                 echo "Trying to build it...";
                 cd /workspace/src/server/runtimes/golang &&          go build -buildvcs=false -o /usr/local/bin/golang-main .
                 if [ $? -eq 0 ]; then
                   echo "✅ Go metafile generator built successfully";
                 else
                   echo "❌ Failed to build Go metafile generator";
                   exit 1
                 fi
               fi
               
               # If example directory exists, download its dependencies
               if [ -f /workspace/example/go.mod ]; then
                 echo "Example project found, downloading dependencies...";
                 cd /workspace/example && go mod download
               fi
               
               # Check if allTests.json exists
               if [ -f /workspace/testeranto/allTests.json ]; then
                 echo "Config file found at /workspace/testeranto/allTests.json";
                 echo "Contents of config file (first 200 chars):";
                 head -c 200 /workspace/testeranto/allTests.json;
                 echo "";
                 # Run the Go metafile generator
                 echo "Running Go metafile generator...";
                 set +e
                 /usr/local/bin/golang-main /workspace/testeranto/allTests.json
                 EXIT_CODE=$?
                 set -e
                 
                 echo "Go metafile generator exited with code: $EXIT_CODE";
                 echo "Checking generated metafile:";
                 ls -la /workspace/testeranto/metafiles/golang/ 2>/dev/null || echo "Go metafiles directory not found";
                 if [ -f /workspace/testeranto/metafiles/golang/allTests.json ]; then
                   echo "Metafile exists at /workspace/testeranto/metafiles/golang/allTests.json";
                   echo "Metafile size:";
                   wc -c /workspace/testeranto/metafiles/golang/allTests.json;
                   echo "Metafile contents (first 500 chars):";
                   head -c 500 /workspace/testeranto/metafiles/golang/allTests.json;
                   echo "";
                 else
                   echo "❌ Metafile not generated!";
                   # Create an empty metafile to satisfy healthcheck
                   echo "Creating empty metafile...";
                   mkdir -p /workspace/testeranto/metafiles/golang
                   echo '{"binaries":[]}' > /workspace/testeranto/metafiles/golang/allTests.json
                 fi
                 echo "Checking generated binaries:";
                 ls -la /workspace/testeranto/bundles/allTests/golang/ 2>/dev/null || echo "Bundles directory not found";
                 echo "Listing all files in bundles directory:";
                 find /workspace/testeranto/bundles/allTests/golang -type f 2>/dev/null || echo "No files found";
               else
                 echo "Config file NOT found at /workspace/testeranto/allTests.json";
                 echo "Creating empty metafile to satisfy healthcheck...";
                 mkdir -p /workspace/testeranto/metafiles/golang
                 echo '{"binaries":[]}' > /workspace/testeranto/metafiles/golang/allTests.json
                 echo "Searching for config files...";
                 find /workspace -name "allTests.json" -type f 2>/dev/null | head -10;
               fi
               
               echo "Go build service ready. Keeping container alive...";
               while true; do
                 sleep 3600
               done
    healthcheck:
      test:
        - CMD-SHELL
        - |-
          if [ -f /workspace/testeranto/metafiles/golang/allTests.json ]; then
                     echo "healthy - metafile exists"
                     exit 0
                   else
                     echo "unhealthy - no metafile found"
                     exit 1
                   fi
      interval: 10s
      timeout: 30s
      retries: 10
      start_period: 60s
  python-builder:
    build:
      context: /Users/adam/Code/testeranto
      dockerfile: testeranto/bundles/allTests/python/python.Dockerfile
      tags:
        - bundles-python-build:latest
      args:
        BUILD_TIMESTAMP: ${BUILD_TIMESTAMP:-${CURRENT_TIMESTAMP}}
    volumes:
      - /Users/adam/Code/testeranto:/workspace
    image: bundles-python-build:latest
    restart: unless-stopped
    environment:
      BUNDLES_DIR: /workspace/testeranto/bundles/allTests/python
      METAFILES_DIR: /workspace/testeranto/metafiles/python
      ESBUILD_SERVE_PORT: '0'
      IN_DOCKER: 'true'
    extra_hosts:
      - host.docker.internal:host-gateway
    command:
      - sh
      - '-c'
      - |-
        echo 'Python service starting...';
               # Verify pylint is available
               python -c "import pylint; print(f'pylint {pylint.__version__} is available')" || {
                 echo "ERROR: pylint not available";
                 exit 1;
               };
               mkdir -p /workspace/testeranto/metafiles/python;
               echo "Checking if allTests.json exists at /workspace/testeranto/allTests.json:";
               if [ -f /workspace/testeranto/allTests.json ]; then
                 echo "Config file found";
               else
                 echo "Config file NOT found";
                 ls -la /workspace/testeranto/ || true;
               fi
               # Run the pitono.py script with the allTests.json config
               cd /workspace && python src/server/runtimes/python/pitono.py /workspace/testeranto/allTests.json;
               echo "Checking if metafile was generated:";
               ls -la /workspace/testeranto/metafiles/python/ || echo "Python metafiles directory not found";
               echo "Checking if bundles were generated:";
               ls -la /workspace/testeranto/bundles/allTests/python/ || echo "Python bundles directory not found";
               echo "Checking for generated text files:";
               find /workspace/testeranto/bundles/allTests/python/ -name "*.txt" -type f | head -10;
               echo 'Python bundle generation completed';
    healthcheck:
      test:
        - CMD-SHELL
        - python -c "import pylint; import sys; sys.exit(0)" || exit 1
      interval: 10s
      timeout: 30s
      retries: 10
      start_period: 60s
volumes:
  node_modules:
    driver: local
networks:
  default:
    name: allTests_network
