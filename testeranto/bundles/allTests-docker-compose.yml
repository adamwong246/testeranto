version: '3.8'
services:
  chromium:
    image: browserless/chrome:latest
    container_name: chromium
    restart: unless-stopped
    ports:
      - '4567:4567'
      - '9222:9222'
    shm_size: 2g
    environment:
      CONNECTION_TIMEOUT: '60000'
      MAX_CONCURRENT_SESSIONS: '10'
      ENABLE_CORS: 'true'
      REMOTE_DEBUGGING_PORT: '9222'
      REMOTE_DEBUGGING_ADDRESS: 0.0.0.0
      PORT: '4567'
    healthcheck:
      test:
        - CMD
        - curl
        - '-f'
        - http://localhost:4567/health
      interval: 10s
      timeout: 10s
      retries: 30
      start_period: 120s
    networks:
      - default
  node-build:
    build:
      context: /Users/adam/Code/testeranto
      dockerfile: testeranto/bundles/allTests/node/node.Dockerfile
      tags:
        - bundles-node-build:latest
      args:
        NODE_MJS_HASH: cab84cac12fc3913ce45e7e53425b8bb
    volumes:
      - /Users/adam/Code/testeranto:/workspace
      - node_modules:/workspace/node_modules
    image: bundles-node-build:latest
    restart: unless-stopped
    environment:
      BUNDLES_DIR: /workspace/testeranto/bundles/allTests/node
      METAFILES_DIR: /workspace/testeranto/metafiles/node
      ESBUILD_SERVE_PORT: '0'
      IN_DOCKER: 'true'
    command:
      - sh
      - '-c'
      - |-
        echo 'Starting node build in watch mode...'; 
                        echo 'Installing dependencies in /workspace/node_modules...'; 
                        cd /workspace &&                 # Remove any .npmrc files
                        rm -f .npmrc .npmrc.* || true &&                 # Clear npm cache and authentication
                        npm cache clean --force &&                 # Clear any npm authentication
                        npm config delete _auth 2>/dev/null || true &&                 npm config delete _authToken 2>/dev/null || true &&                 npm config delete //registry.npmjs.org/:_authToken 2>/dev/null || true &&                 npm config delete //registry.npmjs.org/:_auth 2>/dev/null || true &&                 npm config delete always-auth 2>/dev/null || true &&                 npm config delete registry 2>/dev/null || true &&                 npm config set registry https://registry.npmjs.org/ &&                 npm config set always-auth false &&                 npm install --legacy-peer-deps --no-audit --no-fund --ignore-scripts --no-optional || echo "npm install may have warnings";
                        echo 'Ensuring esbuild and esbuild-sass-plugin are installed for Linux platform...';
                        npm list esbuild 2>/dev/null || npm install --no-save esbuild@0.20.1 --no-audit --no-fund --ignore-scripts --no-optional || echo "esbuild installation may have issues";
                        npm list esbuild-sass-plugin 2>/dev/null || npm install --no-save esbuild-sass-plugin --no-audit --no-fund --ignore-scripts --no-optional || echo "esbuild-sass-plugin installation may have issues";
                        echo 'Creating output directory...'; 
                        mkdir -p /workspace/testeranto/bundles/allTests/node;
                        mkdir -p /workspace/testeranto/metafiles/node;
                        echo 'BUNDLES_DIR env:' "$BUNDLES_DIR"; 
                        # Create a dummy allTests.json to pass health check initially
                        # echo '{"status":"building"}' > /workspace/testeranto/metafiles/node/allTests.json;
                        # Run in watch mode and keep the process alive
                        # Don't fail if chromium isn't ready yet - the build can still proceed
                        echo "Starting build process for node..."
                        npx tsx dist/prebuild/server/builders/node.mjs allTests.ts dev || echo "Build process exited with code $?, but keeping container alive for health checks";
                        # Keep the container running even if the build command exits
                        echo "Build process finished, keeping container alive..."
                        while true; do
                          sleep 3600
                        done
    healthcheck:
      test:
        - CMD-SHELL
        - '[ -f /workspace/testeranto/metafiles/node/allTests.json ] && echo "healthy" || exit 1'
      interval: 10s
      timeout: 30s
      retries: 10
      start_period: 60s
  web-build:
    build:
      context: /Users/adam/Code/testeranto
      dockerfile: testeranto/bundles/allTests/web/web.Dockerfile
      tags:
        - bundles-web-build:latest
      args: {}
    volumes:
      - /Users/adam/Code/testeranto:/workspace
      - node_modules:/workspace/node_modules
    image: bundles-web-build:latest
    restart: unless-stopped
    environment:
      BUNDLES_DIR: /workspace/testeranto/bundles/allTests/web
      METAFILES_DIR: /workspace/testeranto/metafiles/web
      ESBUILD_SERVE_PORT: '0'
      IN_DOCKER: 'true'
    command:
      - sh
      - '-c'
      - |-
        echo 'Starting web build in watch mode...'; 
                        echo 'Installing dependencies in /workspace/node_modules...'; 
                        cd /workspace &&                 # Remove any .npmrc files
                        rm -f .npmrc .npmrc.* || true &&                 # Clear npm cache and authentication
                        npm cache clean --force &&                 # Clear any npm authentication
                        npm config delete _auth 2>/dev/null || true &&                 npm config delete _authToken 2>/dev/null || true &&                 npm config delete //registry.npmjs.org/:_authToken 2>/dev/null || true &&                 npm config delete //registry.npmjs.org/:_auth 2>/dev/null || true &&                 npm config delete always-auth 2>/dev/null || true &&                 npm config delete registry 2>/dev/null || true &&                 npm config set registry https://registry.npmjs.org/ &&                 npm config set always-auth false &&                 npm install --legacy-peer-deps --no-audit --no-fund --ignore-scripts --no-optional || echo "npm install may have warnings";
                        echo 'Ensuring esbuild and esbuild-sass-plugin are installed for Linux platform...';
                        npm list esbuild 2>/dev/null || npm install --no-save esbuild@0.20.1 --no-audit --no-fund --ignore-scripts --no-optional || echo "esbuild installation may have issues";
                        npm list esbuild-sass-plugin 2>/dev/null || npm install --no-save esbuild-sass-plugin --no-audit --no-fund --ignore-scripts --no-optional || echo "esbuild-sass-plugin installation may have issues";
                        echo 'Creating output directory...'; 
                        mkdir -p /workspace/testeranto/bundles/allTests/web;
                        mkdir -p /workspace/testeranto/metafiles/web;
                        echo 'BUNDLES_DIR env:' "$BUNDLES_DIR"; 
                        # Create a dummy allTests.json to pass health check initially
                        # echo '{"status":"building"}' > /workspace/testeranto/metafiles/web/allTests.json;
                        # Run in watch mode and keep the process alive
                        # Don't fail if chromium isn't ready yet - the build can still proceed
                        echo "Starting build process for web..."
                        npx tsx dist/prebuild/server/builders/web.mjs allTests.ts dev || echo "Build process exited with code $?, but keeping container alive for health checks";
                        # Keep the container running even if the build command exits
                        echo "Build process finished, keeping container alive..."
                        while true; do
                          sleep 3600
                        done
    healthcheck:
      test:
        - CMD-SHELL
        - '[ -f /workspace/testeranto/metafiles/web/allTests.json ] && echo "healthy" || exit 1'
      interval: 10s
      timeout: 30s
      retries: 10
      start_period: 60s
    depends_on:
      chromium:
        condition: service_started
  golang-build:
    build:
      context: /Users/adam/Code/testeranto
      dockerfile: testeranto/bundles/allTests/golang/golang.Dockerfile
      tags:
        - bundles-golang-build:latest
      args: {}
    volumes:
      - /Users/adam/Code/testeranto:/workspace
      - node_modules:/workspace/node_modules
    image: bundles-golang-build:latest
    restart: unless-stopped
    environment:
      BUNDLES_DIR: /workspace/testeranto/bundles/allTests/golang
      METAFILES_DIR: /workspace/testeranto/metafiles/golang
      ESBUILD_SERVE_PORT: '0'
      IN_DOCKER: 'true'
    command:
      - sh
      - '-c'
      - |-
        echo 'Starting golang build in watch mode...'; 
                        echo 'Installing dependencies in /workspace/node_modules...'; 
                        cd /workspace &&                 # Remove any .npmrc files
                        rm -f .npmrc .npmrc.* || true &&                 # Clear npm cache and authentication
                        npm cache clean --force &&                 # Clear any npm authentication
                        npm config delete _auth 2>/dev/null || true &&                 npm config delete _authToken 2>/dev/null || true &&                 npm config delete //registry.npmjs.org/:_authToken 2>/dev/null || true &&                 npm config delete //registry.npmjs.org/:_auth 2>/dev/null || true &&                 npm config delete always-auth 2>/dev/null || true &&                 npm config delete registry 2>/dev/null || true &&                 npm config set registry https://registry.npmjs.org/ &&                 npm config set always-auth false &&                 npm install --legacy-peer-deps --no-audit --no-fund --ignore-scripts --no-optional || echo "npm install may have warnings";
                        echo 'Ensuring esbuild and esbuild-sass-plugin are installed for Linux platform...';
                        npm list esbuild 2>/dev/null || npm install --no-save esbuild@0.20.1 --no-audit --no-fund --ignore-scripts --no-optional || echo "esbuild installation may have issues";
                        npm list esbuild-sass-plugin 2>/dev/null || npm install --no-save esbuild-sass-plugin --no-audit --no-fund --ignore-scripts --no-optional || echo "esbuild-sass-plugin installation may have issues";
                        echo 'Creating output directory...'; 
                        mkdir -p /workspace/testeranto/bundles/allTests/golang;
                        mkdir -p /workspace/testeranto/metafiles/golang;
                        echo 'BUNDLES_DIR env:' "$BUNDLES_DIR"; 
                        # Create a dummy allTests.json to pass health check initially
                        # echo '{"status":"building"}' > /workspace/testeranto/metafiles/golang/allTests.json;
                        # Run in watch mode and keep the process alive
                        # Don't fail if chromium isn't ready yet - the build can still proceed
                        echo "Starting build process for golang..."
                        npx tsx dist/prebuild/server/builders/golang.mjs allTests.ts dev || echo "Build process exited with code $?, but keeping container alive for health checks";
                        # Keep the container running even if the build command exits
                        echo "Build process finished, keeping container alive..."
                        while true; do
                          sleep 3600
                        done
    healthcheck:
      test:
        - CMD-SHELL
        - '[ -f /workspace/testeranto/metafiles/golang/allTests.json ] && echo "healthy" || exit 1'
      interval: 10s
      timeout: 30s
      retries: 10
      start_period: 60s
  python-build:
    build:
      context: /Users/adam/Code/testeranto
      dockerfile: testeranto/bundles/allTests/python/python.Dockerfile
      tags:
        - bundles-python-build:latest
      args: {}
    volumes:
      - /Users/adam/Code/testeranto:/workspace
      - node_modules:/workspace/node_modules
    image: bundles-python-build:latest
    restart: unless-stopped
    environment:
      BUNDLES_DIR: /workspace/testeranto/bundles/allTests/python
      METAFILES_DIR: /workspace/testeranto/metafiles/python
      ESBUILD_SERVE_PORT: '0'
      IN_DOCKER: 'true'
    command:
      - sh
      - '-c'
      - |-
        echo 'Starting python build in watch mode...'; 
                        echo 'Installing dependencies in /workspace/node_modules...'; 
                        cd /workspace &&                 # Remove any .npmrc files
                        rm -f .npmrc .npmrc.* || true &&                 # Clear npm cache and authentication
                        npm cache clean --force &&                 # Clear any npm authentication
                        npm config delete _auth 2>/dev/null || true &&                 npm config delete _authToken 2>/dev/null || true &&                 npm config delete //registry.npmjs.org/:_authToken 2>/dev/null || true &&                 npm config delete //registry.npmjs.org/:_auth 2>/dev/null || true &&                 npm config delete always-auth 2>/dev/null || true &&                 npm config delete registry 2>/dev/null || true &&                 npm config set registry https://registry.npmjs.org/ &&                 npm config set always-auth false &&                 npm install --legacy-peer-deps --no-audit --no-fund --ignore-scripts --no-optional || echo "npm install may have warnings";
                        echo 'Ensuring esbuild and esbuild-sass-plugin are installed for Linux platform...';
                        npm list esbuild 2>/dev/null || npm install --no-save esbuild@0.20.1 --no-audit --no-fund --ignore-scripts --no-optional || echo "esbuild installation may have issues";
                        npm list esbuild-sass-plugin 2>/dev/null || npm install --no-save esbuild-sass-plugin --no-audit --no-fund --ignore-scripts --no-optional || echo "esbuild-sass-plugin installation may have issues";
                        echo 'Creating output directory...'; 
                        mkdir -p /workspace/testeranto/bundles/allTests/python;
                        mkdir -p /workspace/testeranto/metafiles/python;
                        echo 'BUNDLES_DIR env:' "$BUNDLES_DIR"; 
                        # Create a dummy allTests.json to pass health check initially
                        # echo '{"status":"building"}' > /workspace/testeranto/metafiles/python/allTests.json;
                        # Run in watch mode and keep the process alive
                        # Don't fail if chromium isn't ready yet - the build can still proceed
                        echo "Starting build process for python..."
                        npx tsx dist/prebuild/server/builders/python.mjs allTests.ts dev || echo "Build process exited with code $?, but keeping container alive for health checks";
                        # Keep the container running even if the build command exits
                        echo "Build process finished, keeping container alive..."
                        while true; do
                          sleep 3600
                        done
    healthcheck:
      test:
        - CMD-SHELL
        - '[ -f /workspace/testeranto/metafiles/python/allTests.json ] && echo "healthy" || exit 1'
      interval: 10s
      timeout: 30s
      retries: 10
      start_period: 60s
  golang-example-calculator-golingvu-test-go:
    restart: 'no'
    shm_size: 2g
    environment:
      CONNECTION_TIMEOUT: '60000'
      MAX_CONCURRENT_SESSIONS: '10'
      ENABLE_CORS: 'true'
      REMOTE_DEBUGGING_PORT: '9222'
      REMOTE_DEBUGGING_ADDRESS: 0.0.0.0
      WS_PORT: '3456'
      WS_HOST: host.docker.internal
      IN_DOCKER: 'true'
      MONITOR_CAPTURE_TEST_OUTPUT: 'true'
      MONITOR_CAPTURE_COVERAGE: 'false'
    networks:
      - default
    build:
      context: /Users/adam/Code/testeranto
      dockerfile: testeranto/bundles/allTests/golang/example/Dockerfile
    volumes:
      - /Users/adam/Code/testeranto:/workspace
      - node_modules:/workspace/node_modules
    working_dir: /workspace
    depends_on:
      golang-build:
        condition: service_healthy
    command:
      - sh
      - '-c'
      - |2-

                  echo "=== Running Go BDD test ==="
                  echo "Static analysis was performed during build phase"
                  cd /workspace/example && go test -v ./...
                  echo "BDD test completed, keeping container alive..."
                  sleep 3600
                
  python-example-calculator-pitono-test-py:
    restart: 'no'
    shm_size: 2g
    environment:
      CONNECTION_TIMEOUT: '60000'
      MAX_CONCURRENT_SESSIONS: '10'
      ENABLE_CORS: 'true'
      REMOTE_DEBUGGING_PORT: '9222'
      REMOTE_DEBUGGING_ADDRESS: 0.0.0.0
      WS_PORT: '3456'
      WS_HOST: host.docker.internal
      IN_DOCKER: 'true'
      MONITOR_CAPTURE_PYTEST_OUTPUT: 'true'
      MONITOR_CAPTURE_LOGGING: 'true'
    networks:
      - default
    build:
      context: /Users/adam/Code/testeranto
      dockerfile: testeranto/bundles/allTests/python/example/Dockerfile
    volumes:
      - /Users/adam/Code/testeranto:/workspace
      - node_modules:/workspace/node_modules
    working_dir: /workspace
    depends_on:
      python-build:
        condition: service_healthy
    command:
      - sh
      - '-c'
      - |2-

                  echo "=== Running Python BDD test ==="
                  echo "Static analysis is running in parallel service"
                  if [ -f "/workspace/example/Calculator.pitono.test.py" ]; then 
                    python3 -m pytest "/workspace/example/Calculator.pitono.test.py" -v
                  else 
                    echo "Test file not found: /workspace/example/Calculator.pitono.test.py"
                    exit 1
                  fi
                  echo "BDD test completed, keeping container alive..."
                  sleep 3600
                
  web-example-calculator-test-ts-static-analysis:
    restart: 'no'
    shm_size: 2g
    environment:
      CONNECTION_TIMEOUT: '60000'
      MAX_CONCURRENT_SESSIONS: '10'
      ENABLE_CORS: 'true'
      REMOTE_DEBUGGING_PORT: '9222'
      REMOTE_DEBUGGING_ADDRESS: 0.0.0.0
      WS_PORT: '3456'
      WS_HOST: host.docker.internal
      IN_DOCKER: 'true'
    networks:
      - default
    image: node:20.19.4-alpine
    volumes:
      - /Users/adam/Code/testeranto:/workspace
      - node_modules:/workspace/node_modules
    working_dir: /workspace
    depends_on:
      web-build:
        condition: service_healthy
      chromium:
        condition: service_healthy
    command:
      - sh
      - '-c'
      - |2-

                    echo "=== Running Web static analysis ==="
                    # Install npm if not available
                    if ! command -v npm &> /dev/null; then
                      echo "Installing npm..."
                      apk add --update npm 2>/dev/null || echo "npm installation may have failed"
                    fi
                    # Install dependencies
                    if [ -f "/workspace/package.json" ]; then
                      echo "Installing dependencies from package.json..."
                      cd /workspace && npm install --no-audit --no-fund --ignore-scripts 2>&1 | tail -5 || echo "npm install may have warnings"
                    fi
                    # Check for ESLint
                    echo "Checking for ESLint..."
                    if npx --no-install eslint --version 2>/dev/null; then
                      echo "Running ESLint..."
                      npx eslint "/workspace/example/Calculator.test.ts" 2>&1 || echo "ESLint check completed"
                    else
                      echo "ESLint not available, skipping"
                    fi
                    # Check for TypeScript
                    echo "Checking for TypeScript..."
                    if npx --no-install tsc --version 2>/dev/null; then
                      echo "Running TypeScript type check..."
                      npx tsc --noEmit "/workspace/example/Calculator.test.ts" 2>&1 || echo "TypeScript check completed"
                    else
                      echo "TypeScript not available, skipping"
                    fi
                    # Check for stylelint
                    echo "Checking for stylelint..."
                    if npx --no-install stylelint --version 2>/dev/null; then
                      echo "Running stylelint..."
                      # Find CSS/SCSS files in the same directory
                      find $(dirname "/workspace/example/Calculator.test.ts") -name "*.css" -o -name "*.scss" 2>/dev/null | head -3 | while read cssFile; do
                        if [ -f "$cssFile" ]; then
                          npx stylelint "$cssFile" 2>&1 || echo "stylelint check completed for $cssFile"
                        fi
                      done
                    else
                      echo "stylelint not available, skipping"
                    fi
                    echo "Static analysis completed, keeping container alive..."
                    sleep 3600
                  
  python-example-calculator-pitono-test-py-static-analysis:
    restart: 'no'
    shm_size: 2g
    environment:
      CONNECTION_TIMEOUT: '60000'
      MAX_CONCURRENT_SESSIONS: '10'
      ENABLE_CORS: 'true'
      REMOTE_DEBUGGING_PORT: '9222'
      REMOTE_DEBUGGING_ADDRESS: 0.0.0.0
      WS_PORT: '3456'
      WS_HOST: host.docker.internal
      IN_DOCKER: 'true'
    networks:
      - default
    image: python:3.11-alpine
    volumes:
      - /Users/adam/Code/testeranto:/workspace
      - node_modules:/workspace/node_modules
    working_dir: /workspace
    depends_on:
      python-build:
        condition: service_healthy
    command:
      - sh
      - '-c'
      - |2-

                    echo "=== Running Python static analysis ==="
                    # Install Python static analysis tools if not available
                    echo "Installing Python static analysis tools..."
                    pip install --quiet flake8 pylint mypy 2>/dev/null || echo "Tool installation may have failed"
                    # Run flake8 if available
                    if command -v flake8 &> /dev/null && [ -f "/workspace/example/Calculator.pitono.test.py" ]; then
                      echo "Running flake8..."
                      flake8 "/workspace/example/Calculator.pitono.test.py" 2>&1 || echo "flake8 completed"
                    else
                      echo "flake8 not available"
                    fi
                    # Run pylint if available
                    if command -v pylint &> /dev/null && [ -f "/workspace/example/Calculator.pitono.test.py" ]; then
                      echo "Running pylint..."
                      pylint "/workspace/example/Calculator.pitono.test.py" 2>&1 || echo "pylint completed"
                    else
                      echo "pylint not available"
                    fi
                    # Run mypy if available
                    if command -v mypy &> /dev/null && [ -f "/workspace/example/Calculator.pitono.test.py" ]; then
                      echo "Running mypy..."
                      mypy "/workspace/example/Calculator.pitono.test.py" 2>&1 || echo "mypy completed"
                    else
                      echo "mypy not available"
                    fi
                    echo "Static analysis completed, keeping container alive..."
                    sleep 3600
                  
volumes:
  node_modules:
    driver: local
networks:
  default:
    name: allTests_network
